<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Informacion Socieconomica</title>
  <link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; width:100%; font-family:'Segoe UI', Arial, sans-serif; background:#f4f4f4; }
    :root{ --sidebar-w:320px; }
    #panel-lateral{
      position:absolute;
      left:0; top:0; bottom:0; width:var(--sidebar-w); height:100%;
      background: linear-gradient(180deg, #8ea3ad 0%, #dfe6e9 100%);
      color:#2c3e50; border-right:1px solid #b2bec3;
      display:flex; flex-direction:column; 
      box-shadow:2px 0 5px rgba(0,0,0,0.1); box-sizing:border-box; align-items:stretch;
      z-index:2000;
    }
    #panel-header{ background:#b2bec3; color:#2c3e50; padding:12px 15px; display:flex; align-items:center; font-size:18px; font-weight:bold; }
    #panel-header img{ height:32px; margin-right:10px; }
    #map{ position:absolute; top:0; left:var(--sidebar-w); width:calc(100% - var(--sidebar-w)); height:100%; }

    #sec-search    { position: relative; }                /* contenedor del buscador */
    #sec-suggest   { z-index: 3000; } 
    #sec-suggest {
      position: absolute;
      left: 12px; right: 12px;
      top: 46px;           /* ajusta seg√∫n tu input */
      max-height: 220px;
      overflow: auto;
    }
      /* la lista queda clickeable */

    /* Etiqueta de la SECCI√ìN seleccionada (rosa tenue) */
    .sec-label{
      background: rgba(255, 235, 238, 0.96);  /* #ffebee */
      border: 1px solid #e91e63;
      color: #880e4f;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
      pointer-events: none;
      white-space: nowrap;
      box-shadow: 0 2px 6px rgba(0,0,0,.15);
    }

    /* Etiquetas de SECCIONES ADYACENTES (azul/gris tenue) */
    .sec-label-adj{
      background: rgba(227, 242, 253, 0.94);  /* #e3f2fd */
      border: 1px solid #64b5f6;
      color: #0d47a1;
      padding: 1px 5px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      pointer-events: none;
      white-space: nowrap;
      box-shadow: 0 1px 4px rgba(0,0,0,.12);
    }


    /* Panel flotante secci√≥n */
    #sec-info {
      position: absolute;
      left: 10px; top:400px;
      width: 300px; max-width: 38vw; min-width: 260px;
      background: #ffffff;
      border: 1px solid #cfd8dc;
      border-radius: 10px;
      box-shadow: 0 10px 24px rgba(0,0,0,.15);
      resize: both; overflow: auto; z-index: 4000;
      display: none;
      pointer-events: auto;
    }
    #sec-info .hdr {
      cursor: move;
      display:flex; align-items:center; justify-content:space-between;
      background: linear-gradient(180deg,#eceff1,#e3f2fd);
      padding: 8px 12px;
      border-bottom: 1px solid #cfd8dc;
      font-weight: 700; color: #263238;
    }

    #sec-info .hdr .btn-close{
      cursor: pointer;
      border: none; outline: none;
      background: #ffcdd2;         /* rosa tenue */
      color: #880e4f;
      width: 24px; height: 24px; line-height: 24px;
      border-radius: 6px;
      font-size: 16px; font-weight: 800;
    }
    #sec-info .hdr .btn-close:hover{ background:#ef9a9a; }
    #sec-info .body { padding: 10px 12px; color: #37474f; }
    #sec-info .row  { display:flex; justify-content:space-between; margin:6px 0; }
    #sec-info .k    { color:#607d8b; }
    #sec-info .v    { font-weight:600; }
    

      
    /* === AQUI EMPIEZA: CSS Barra SOCIAL (SOC_TB) === */
    .soc-tb{
      position:absolute; left:50%; top:12px; z-index:3500;transform:translateX(-50%);
      background:#ffffff; border:1px solid #e6e6e6; border-radius:16px;
      right:auto;
      box-shadow:0 12px 28px rgba(0,0,0,.16); padding:8px 10px; width:auto;
      display:flex; flex-direction:row; gap:10px; align-items:center;
    }
    .soc-tb__group{ display:flex; flex-direction:row; gap:8px; width:100%; }
    .soc-tb__btn{
      width:36px; height:36px; border-radius:12px; border:1px solid #eee;
      background:#fafafa; cursor:pointer; font-size:18px; line-height:34px;
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
    }
    .soc-tb__btn:hover{ transform:translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.10); background:#fff; }
    .soc-tb__toggle{
      position:absolute; right:8px; top:-12px; width:22px; height:22px;
      border-radius:10px; border:1px solid #e6e6e6; background:#7a1c2f; color:#fff; cursor:pointer;
      box-shadow:0 6px 16px rgba(0,0,0,.18); font-weight:700;
    }
    .soc-tb:not(.soc-tb-open){ width:20px; padding:10px 6px; }
    .soc-tb:not(.soc-tb-open) .soc-tb__group, 
    .soc-tb:not(.soc-tb-open) .soc-tb__btn{ display:none; }

    /* === Overrides para layout horizontal superior === */
    .soc-tb--top{
      position:absolute;
      top:12px; left:50%; transform:translateX(-50%); right:auto;
      width:auto; padding:8px 10px;
      display:flex; flex-direction:row; align-items:center; gap:10px;
    }
    .soc-tb--top .soc-tb__group{
      display:flex; flex-direction:row; gap:8px;
      border-left:1px solid #eee; padding-left:8px; margin-left:8px;
    }
    .soc-tb--top .soc-tb__group:first-of-type{
      border-left:none; padding-left:0; margin-left:0;
    }
    .soc-tb--top .soc-tb__toggle{
      position:absolute; right:8px; top:-12px;
      width:24px; height:24px; border-radius:12px;
      background:#7a1c2f; color:#fff; border:1px solid #e6e6e6;
      cursor:pointer; font-weight:700; box-shadow:0 6px 16px rgba(0,0,0,.18);
    }

    /* Estado colapsado (arriba): esconde grupos pero deja visible el toggle */
    .soc-tb--top:not(.soc-tb-open){ padding:6px 10px; }
    .soc-tb--top:not(.soc-tb-open) .soc-tb__group,
    .soc-tb--top:not(.soc-tb-open) .soc-tb__btn{ display:none; }

    /* Peque√±o ajuste responsivo: si la pantalla es angosta, al√≠neala a la izquierda */
    @media (max-width: 900px){
      .soc-tb--top{ left:12px; transform:none; }
    }


    /* === AQUI TERMINA: CSS Barra SOCIAL (SOC_TB) === */

    /* === CSS FICHA SOCIOECON√ìMICA [SOC_FICHA_v1_2020] === */
    .socf-card{
      margin-top:12px; background:#fff; border:1px solid #eee; border-radius:14px;
      box-shadow:0 8px 20px rgba(0,0,0,.06); padding:12px;
    }
    .socf-header{ display:flex; align-items:baseline; justify-content:space-between; gap:10px; }
    .socf-header h3{ margin:0; font-size:16px; color:#1c1c1c; }
    #SOC_FICHA_badge{ background:#f6e9ec; color:#7a1c2f; padding:2px 8px; border-radius:999px; }
    .socf-kpis{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin:10px 0 6px; }
    .socf-kpi{ background:#fafafa; border:1px solid #eee; border-radius:10px; padding:8px; text-align:center; }
    .socf-kpi .kpi-label{ font-size:11px; color:#666; }
    .socf-kpi .kpi-val{ font-size:18px; font-weight:700; }
    .socf-subttl{ margin:10px 0 6px; font-size:13px; color:#333; }
    .socf-grid{ display:grid; grid-template-columns:1fr 1fr; gap:6px 10px; }
    .socf-row{ display:flex; align-items:center; justify-content:space-between; border-bottom:1px dashed #f0f0f0; padding:4px 0; }
    .socf-foot{ margin-top:6px; color:#777; font-size:11px; }
    /* === /CSS FICHA === */



  </style>
</head>
<body>
  <div id="panel-lateral">
    <div id="panel-header">
      <!-- <img src="assets/img/logo.png" alt="Logo"/> -->
      <span>Informacion Socieconomica</span>
    </div>
    <!-- Aqu√≠ va el contenido del panel lateral -->

    <!-- Buscador de secciones -->
    <div id="sec-search" style="padding:10px 12px; border-top:1px solid #cbd5e1; background:#eef2f7">
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="sec-q" type="text" placeholder="Buscar secci√≥n (ej. 1234 o '1234 Le√≥n')" autocomplete="off" autocorrect="off" spellcheck="false" enterkeyhint="search"
              style="flex:1; padding:6px 8px; border:1px solid #94a3b8; border-radius:6px;">
        <label style="white-space:nowrap; font-size:12px;">
          <input id="sec-global" type="checkbox"> Todo el estado
        </label>
      </div>
      <ul id="sec-suggest" style="margin:8px 0 0 0; padding:0; list-style:none; max-height:180px; overflow:auto;
                                  border:1px solid #cbd5e1; border-radius:6px; background:#fff; display:none;"></ul>
    </div>



    <div id="mini-universe" style="padding:12px 12px 6px 12px; background:#eef2f7; border-top:1px solid #cbd5e1">
        <div class="row" style="margin-bottom:8px">
            <label><input type="checkbox" id="mini-all-state"> Estado completo</label>
        </div>
        <div class="row" style="margin-bottom:8px">
            <label>Municipio</label>
            <select id="mini-sel-mun" style="width:100%;padding:6px"><option value="">‚Äî Ninguno ‚Äî</option></select>
        </div>
        <div class="row" style="margin-bottom:8px">
            <label>Distrito Federal</label>
            <select id="mini-sel-df" style="width:100%;padding:6px"><option value="">‚Äî Ninguno ‚Äî</option></select>
        </div>
        <div class="row" style="margin-bottom:8px">
            <label>Distrito Local</label>
            <select id="mini-sel-dl" style="width:100%;padding:6px"><option value="">‚Äî Ninguno ‚Äî</option></select>
        </div>
        <div class="hint" style="font-size:12px;color:#64748b">Elige solo uno. Al cambiar, el mapa se actualiza.</div>
    </div>

  </div>
  <div id="map"></div>

  <!-- === AQUI EMPIEZA: Barra de herramientas SOCIAL (SOC_TB) === -->
  <div id="SOC_TB" class="soc-tb soc-tb-open" aria-label="Acciones r√°pidas">
    <button id="SOC_TB_toggle" class="soc-tb__toggle" title="Colapsar/Expandir">¬´</button>

    <div class="soc-tb__group">
      <button id="SOC_TB_focus"   class="soc-tb__btn" title="Centrar √∫ltima secci√≥n (F)">
        üéØ
      </button>
      <button id="SOC_TB_adj"     class="soc-tb__btn" title="Mostrar/ocultar adyacentes (A)">
        üß©
      </button>
      <button id="SOC_TB_labels"  class="soc-tb__btn" title="Mostrar/ocultar etiquetas (L)">
        üè∑Ô∏è
      </button>
    </div>

    <div class="soc-tb__group">
      <button id="SOC_TB_clear"   class="soc-tb__btn" title="Limpiar selecci√≥n (C)">
        üßπ
      </button>
      <button id="SOC_TB_export"  class="soc-tb__btn" title="Exportar PNG del mapa (E)">
        üñºÔ∏è
      </button>
      <button id="SOC_TB_share"   class="soc-tb__btn" title="Copiar liga a esta secci√≥n (S)">
        üîó
      </button>
    </div>
  </div>
<!-- === AQUI TERMINA: Barra de herramientas SOCIAL (SOC_TB) === -->



  <!-- === SCRIPT √öNICO === -->
  <script>
  // ===== 0) Campos (ajusta si tus nombres son distintos) =====
  // DL = Distrito Local, DF = Distrito Federal
  const FIELD_KEYS = { mun: 'MUNICIPIO', dl: 'DISTRITO_L', df: 'DISTRITO_F' };


    const paths = JSON.parse(localStorage.getItem('AT_PATHS')||'{}');
    const urlGeo = paths.geo || 'data/geo/secciones.geojson';
    const catUrl = paths.catalog || 'data/catalogo_territorial.json';
    const ELP = paths.electoral?.P || 'data/electoral/P.json';
  // ...

    
      // === Ficha socioecon√≥mica (carga perezosa + cach√©) ===
      const SOCF = {
        url: (JSON.parse(localStorage.getItem('AT_PATHS')||'{}').social) || 'data/Datos_Socioeconomicos.json',
        bySec: new Map(),
        loaded: false
      };

      function fmt(n, suf=''){ return (n==null || isNaN(n)) ? '‚Äî' : Number(n).toLocaleString('es-MX') + suf; }
      function safeDiv(a,b){ a=Number(a)||0; b=Number(b)||0; return b? (a/b) : 0; }

    async function ensureSocLoaded(){
      if (SOCF.loaded) return;

      // normaliza cualquier forma de id a "n√∫mero sin ceros a la izquierda"
      const norm = s => {
        const n = parseInt(String(s||'').trim(), 10);
        return Number.isFinite(n) ? String(n) : '';
      };
      SOCF.idNorm = norm; // guarda para reusar en render

      const res = await fetch(SOCF.url);
      if (!res.ok) throw new Error(`HTTP ${res.status} al cargar ${SOCF.url}`);
      const raw = await res.json();

      const toNum = v => (v==null ? 0 : (typeof v==='number' ? v : (parseFloat(String(v).replace(/,/g,''))||0)));

      SOCF.bySec.clear();

      if (Array.isArray(raw)) {
        for (const r of raw){
          const sec = norm(r.SECCION ?? r.seccion ?? r.Seccion);
          if (!sec) continue;
          const P15 = toNum(r.POB_15_17), P18 = toNum(r.POB_18MAS);
          const OC  = toNum(r.OCUPADOS_12MAS), DE = toNum(r.DESOCUPADOS_12MAS);
          const P15M = P15 + P18, PEA = OC + DE;
          SOCF.bySec.set(sec, {
            POB_TOTAL: toNum(r.POB_TOTAL),
            POB_15_17: P15, POB_18MAS: P18, POB_15MAS: P15M,
            ESCOLARIDAD_PROM: toNum(r.ESCOLARIDAD_PROM),
            ANALFABETAS_15MAS: toNum(r.ANALFABETAS_15MAS),
            PEA_12MAS: PEA, OCUPADOS_12MAS: OC, DESOCUPADOS_12MAS: DE,
            TASA_ANALF_15MAS: P15M ? (toNum(r.ANALFABETAS_15MAS)/P15M)*100 : 0,
            TASA_DESEMP:      PEA ? (DE/PEA)*100 : 0,
            SERV_ELECTRICIDAD_PMH: (toNum(r.VIV_CON_ELECTRICIDAD)/Math.max(1,toNum(r.POB_TOTAL)))*1000,
            SERV_AGUA_PMH:         (toNum(r.VIV_CON_AGUA)/Math.max(1,toNum(r.POB_TOTAL)))*1000,
            SERV_DRENAJE_PMH:      (toNum(r.VIV_CON_DRENAJE)/Math.max(1,toNum(r.POB_TOTAL)))*1000,
            SERV_INTERNET_PMH:     (toNum(r.VIV_CON_INTERNET)/Math.max(1,toNum(r.POB_TOTAL)))*1000,
            SERV_CEL_PMH:          (toNum(r.VIV_CON_CEL)/Math.max(1,toNum(r.POB_TOTAL)))*1000,
            SERV_PC_PMH:           (toNum(r.VIV_CON_PC)/Math.max(1,toNum(r.POB_TOTAL)))*1000,
          });
        }
      } else if (raw && typeof raw === 'object') {
        // TU CASO: objeto indexado por secci√≥n {"1": {...}, "2": {...}}
        for (const [secKey, r] of Object.entries(raw)){
          const sec = norm(secKey);
          const P15 = toNum(r.POB_15_17), P18 = toNum(r.POB_18MAS);
          const OC  = toNum(r.OCUPADOS_12MAS), DE = toNum(r.DESOCUPADOS_12MAS);
          const P15M = P15 + P18, PEA = OC + DE;
          SOCF.bySec.set(sec, {
            POB_TOTAL: toNum(r.POB_TOTAL),
            POB_15_17: P15, POB_18MAS: P18, POB_15MAS: P15M,
            ESCOLARIDAD_PROM: toNum(r.ESCOLARIDAD_PROM),
            ANALFABETAS_15MAS: toNum(r.ANALFABETAS_15MAS),
            PEA_12MAS: PEA, OCUPADOS_12MAS: OC, DESOCUPADOS_12MAS: DE,
            TASA_ANALF_15MAS: P15M ? (toNum(r.ANALFABETAS_15MAS)/P15M)*100 : 0,
            TASA_DESEMP:      PEA ? (DE/PEA)*100 : 0,
            SERV_ELECTRICIDAD_PMH: (toNum(r.VIV_CON_ELECTRICIDAD)/Math.max(1,toNum(r.POB_TOTAL)))*1000,
            SERV_AGUA_PMH:         (toNum(r.VIV_CON_AGUA)/Math.max(1,toNum(r.POB_TOTAL)))*1000,
            SERV_DRENAJE_PMH:      (toNum(r.VIV_CON_DRENAJE)/Math.max(1,toNum(r.POB_TOTAL)))*1000,
            SERV_INTERNET_PMH:     (toNum(r.VIV_CON_INTERNET)/Math.max(1,toNum(r.POB_TOTAL)))*1000,
            SERV_CEL_PMH:          (toNum(r.VIV_CON_CEL)/Math.max(1,toNum(r.POB_TOTAL)))*1000,
            SERV_PC_PMH:           (toNum(r.VIV_CON_PC)/Math.max(1,toNum(r.POB_TOTAL)))*1000,
          });
        }
      }

      SOCF.loaded = true;
    }



    async function renderSocFicha(sec, ln2024){
      const card = document.getElementById('SOCF_card');
      if (!card) return;
      await ensureSocLoaded();

      // Normaliza key
      const key = String(parseInt(String(sec||'').trim(), 10));
      const row = SOCF.bySec.get(key);

      const FMT = (n, suf='') => (n==null||isNaN(n)) ? '‚Äî' : Number(n).toLocaleString('es-MX') + suf;

      if(!row){
        card.style.display = 'block';
        card.querySelectorAll('.v').forEach(v => v.textContent = '‚Äî');
        return;
      }

      // --- KPI base (2020)
      const P18_2020 = Number(row.POB_18MAS||0);
            // --- Proyecci√≥n 2027 usando LN-2024 como ancla
      const LN_2024 = Number(ln2024 || 0);
      let pob18_2027 = null;
      if (P18_2020 > 0 && LN_2024 > 0){
        const ratio_2020_2024 = LN_2024 / P18_2020;      // crecimiento efectivo 4 a√±os
        const factor_7yrs     = Math.pow(ratio_2020_2024, 7/4); // 2020->2027
        pob18_2027 = Math.round(P18_2020 * factor_7yrs);
      }
      document.getElementById('SOCF_pob').textContent   = FMT(row.POB_TOTAL||0);
      document.getElementById('SOCF_pob_18mas').textContent   = fmt(row.POB_18MAS);
      document.getElementById('SOCF_pob18_2027').textContent = FMT(pob18_2027);
      document.getElementById('SOCF_analf').textContent = FMT(row.TASA_ANALF_15MAS||0, ' %');
      document.getElementById('SOCF_desemp').textContent= FMT(row.TASA_DESEMP||0, ' %');

      // --- Servicios por mil hab. (2020)
      document.getElementById('SOCF_ele').textContent = FMT(row.SERV_ELECTRICIDAD_PMH);
      document.getElementById('SOCF_agua').textContent= FMT(row.SERV_AGUA_PMH);
      document.getElementById('SOCF_dre').textContent = FMT(row.SERV_DRENAJE_PMH);
      document.getElementById('SOCF_net').textContent = FMT(row.SERV_INTERNET_PMH);
      document.getElementById('SOCF_cel').textContent = FMT(row.SERV_CEL_PMH);
      document.getElementById('SOCF_pc').textContent  = FMT(row.SERV_PC_PMH);


      

      card.style.display = 'block';
    }



      


  // ===== 1) Mapa √∫nico y chequeo =====
  function ensureLeafletMap() {
    if (window.__AT_MAP && window.__AT_MAP instanceof L.Map) return window.__AT_MAP;
    const m = L.map('map', { zoomControl:true }).setView([21.0, -101.3], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'¬© OSM' }).addTo(m);
    window.__AT_MAP = m;
    return m;
  }
  function assertIsLeafletMap(m) {
    if (!(m instanceof L.Map) || typeof m.addLayer !== 'function') {
      throw new Error('[AT] addTo(): destino no es un Leaflet Map. Revisa variables llamadas "map" o dobles inicializaciones.');
    }
  }

  function closeSecInfoPanel(){
    const box = document.getElementById('sec-info');
    if (box) box.style.display = 'none';
    // Si quieres limpiar resaltado y etiquetas al cerrar:
    if (typeof clearSectionOverlays === 'function') clearSectionOverlays();
  }


  function ensureSecInfoPanelWired(){
  const box = document.getElementById('sec-info');
  const hdr = box?.querySelector('.hdr');
  if (!box || !hdr || box.__wired) return;

  // Bloquear propagaci√≥n al mapa (no ‚Äúparpadea‚Äù al arrastrar)
  if (window.L && L.DomEvent){
    L.DomEvent.disableClickPropagation(box);
    L.DomEvent.disableScrollPropagation(box);
  }

  // Drag del panel
  let dragging = false, sx=0, sy=0, bx=0, by=0;
  hdr.addEventListener('mousedown', (e)=>{
    if (e.target.closest('.btn-close')) return; // no iniciar drag si clic en "√ó"
    e.preventDefault(); e.stopPropagation();
    dragging = true;
    const r = box.getBoundingClientRect();
    sx = e.clientX; sy = e.clientY; bx = r.left; by = r.top;
    box.style.position = 'absolute'; box.style.right='auto'; box.style.bottom='auto';
    document.body.style.userSelect = 'none';
  });
  window.addEventListener('mousemove', (e)=>{
    if (!dragging) return;
    e.preventDefault(); e.stopPropagation();
    const dx = e.clientX - sx, dy = e.clientY - sy;
    box.style.left = (bx + dx) + 'px';
    box.style.top  = (by + dy) + 'px';
  });
  window.addEventListener('mouseup', ()=>{
    if (!dragging) return;
    dragging = false; document.body.style.userSelect = '';
  });

  // Bot√≥n ‚Äú√ó‚Äù
  const btn = document.getElementById('sec-close');
  if (btn && !btn.__wired){
    btn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); closeSecInfoPanel(); });
    btn.__wired = true;
  }

  box.__wired = true;
}



  // ===== 2) Filtrado por universo =====
  function toComp(v){ if(v==null) return ''; const s=String(v).trim(); return (isFinite(s) && s!=='') ? Number(s) : s.toUpperCase(); }
  function matches(props, u){
    if(u.scope==='ALL') return true;
    const keyField = u.scope==='MUN' ? FIELD_KEYS.mun : (u.scope==='DL' ? FIELD_KEYS.dl : FIELD_KEYS.df);
    return toComp(props?.[keyField]) === toComp(u.key);
  }
  function filterGeojson(geojson, u){
    if(u.scope==='ALL') return geojson;
    const features = (geojson.features || []).filter(f => matches(f.properties, u));
    return { ...geojson, features };
  }


  // ====== CARGA ELECTORAL (para obtener 24DL_LN) ======
  function getPaths(){ try{ return JSON.parse(localStorage.getItem('AT_PATHS')||'{}'); }catch{ return {}; } }
  function getPuestoPath(p){ const paths = getPaths(); return paths?.electoral?.[p] || `data/electoral/${p}.json`; }

  window.AT_ELECT = window.AT_ELECT || {};
  async function getElectData(puesto){
    if (window.AT_ELECT[puesto]) return window.AT_ELECT[puesto];
    const res = await fetch(getPuestoPath(puesto));
    if (!res.ok) throw new Error(`HTTP ${res.status} en ${puesto}`);
    const js = await res.json();
    window.AT_ELECT[puesto] = js;
    return js;
  }
  // LN para 2024 desde DL; si no hay, intenta P (fallback)
  async function getLN24DL(sec){
    const key = String(sec);
    try {
      const dl = await getElectData('DL');
      const ln = dl?.secciones?.[key]?.["2024"]?.LN;
      if (typeof ln === 'number') return ln;
    } catch(_){}
    try {
      const p = await getElectData('P');
      const ln = p?.secciones?.[key]?.["2024"]?.LN;
      if (typeof ln === 'number') return ln;
    } catch(_){}
    return null;
  }

  // ====== ADYACENCIAS (Turf) ======
  function bboxIntersects(b1, b2){
    return !(b2[0] > b1[2] || b2[2] < b1[0] || b2[1] > b1[3] || b2[3] < b1[1]);
  }
  function getAdjacents(feat){
    const all = (window.AT_DATA?.features)
            || (window.AT_CTX?.layer?.toGeoJSON?.()?.features)
            || [];
    if (!all.length) return [];
    const b1 = turf.bbox(feat);
    const out = [];
    const sec1 = feat.properties?.SECCION;
    for (const f of all){
      const p = f.properties || {};
      if (p.SECCION === sec1) continue;
      const b2 = turf.bbox(f);
      if (!bboxIntersects(b1,b2)) continue;
      try {
        if (turf.booleanTouches(feat, f) || turf.booleanOverlap(feat, f) || turf.booleanIntersects(feat, f)){
          out.push(f);
        }
      } catch(_){}
    }
    return out.slice(0, 25); // cota de seguridad
  }

  // ====== LABELS SOBRE EL MAPA ======
  function addLabelForFeature(feat, className, text){
    try {
      const c = turf.centerOfMass(feat).geometry.coordinates; // [lon, lat]
      const m = L.marker([c[1], c[0]], { icon: L.divIcon({ className, html: text, iconSize:[0,0] }) });
      window.__SEC_LABELS = window.__SEC_LABELS || L.layerGroup().addTo(ensureLeafletMap());
      window.__SEC_LABELS.addLayer(m);
      return m;
    } catch(_){}
    return null;
  }

  function clearSectionOverlays(){
    const atMap = ensureLeafletMap();
    if (window.__SEC_HL){ try{ atMap.removeLayer(__SEC_HL); }catch(_){ } window.__SEC_HL = null; }
    if (window.__SEC_ADJ){ try{ atMap.removeLayer(__SEC_ADJ); }catch(_){ } window.__SEC_ADJ = null; }
    if (window.__SEC_LABELS){ try{ atMap.removeLayer(__SEC_LABELS); }catch(_){ } window.__SEC_LABELS = null; }
  }

  // Dibuja selecci√≥n + adyacentes + labels
  function paintSelectionAndAdj(feat){
    const atMap = ensureLeafletMap();
    clearSectionOverlays();

    // resaltado principal
    window.__SEC_HL = L.geoJSON(feat, { style:{ color:'#e91e63', weight:3, fillOpacity:0.25 } }).addTo(atMap);
    try { atMap.fitBounds(window.__SEC_HL.getBounds(), { padding:[28,28] }); } catch(_){}

    // adyacentes
    const adj = getAdjacents(feat);
    if (adj.length){
      window.__SEC_ADJ = L.geoJSON({type:'FeatureCollection', features:adj}, { style:{ color:'#90a4ae', weight:1.2, dashArray:'4,4', fillOpacity:0.05 } }).addTo(atMap);
    }

    // labels
    const sec = feat.properties?.SECCION ?? '‚Äî';
    addLabelForFeature(feat, 'sec-label', `Secci√≥n ${sec}`);
    for (const f of adj){
      const s2 = f.properties?.SECCION ?? '‚Äî';
      addLabelForFeature(f, 'sec-label-adj', s2);
    }
  }

  // ====== PANEL FLOTANTE (drag + datos) ======
  (function wireSecInfoPanel(){
    const box = document.getElementById('sec-info');
    const hdr = box?.querySelector('.hdr');
    if (!box || !hdr || box.__wired) return;
    let dragging = false, sx=0, sy=0, bx=0, by=0;
    hdr.addEventListener('mousedown', (e)=>{
      dragging=true; sx=e.clientX; sy=e.clientY;
      const r = box.getBoundingClientRect(); bx=r.left; by=r.top;
      document.body.style.userSelect='none';
    });
    window.addEventListener('mousemove', (e)=>{
      if (!dragging) return;
      const dx = e.clientX - sx, dy = e.clientY - sy;
      box.style.left = (bx + dx) + 'px';
      box.style.top  = (by + dy) + 'px';
      box.style.right = 'auto'; box.style.bottom='auto';
      box.style.position = 'absolute';
    });
    window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
    box.__wired = true;
  })();

function __num(v){ return Number(String(v ?? '').replace(/,/g,'').trim()) || 0; }

function getLN2024(props){
    if(!props) return 0;

    // 1) candidatos conocidos (ajusta o agrega si usas otro)
    const exact = [
      '24DL_LN','24A_LN','LN_2024','LN24','LISTA_NOMINAL_2024',
      '24_DL_LN','24LN','LN' // deja 'LN' al final por si lo usas gen√©rico
    ];
    for(const k of exact){
      if (k in props && String(props[k]).trim()!=='') return __num(props[k]);
    }

    // 2) patrones comunes: "algo con LN y 2024", o "lista nominal 2024"
    for (const [k,v] of Object.entries(props)){
      if (/LN.*2024/i.test(k) || /LISTA.*NOM/i.test(k)) return __num(v);
    }

    // 3) √∫ltimo recurso: el mayor valor num√©rico en claves con "LN"
    let best = 0;
    for (const [k,v] of Object.entries(props)){
      if (/LN/i.test(k)) best = Math.max(best, __num(v));
    }
    return best;
  }


  async function showSectionInfo(feat){
    ensureSecInfoPanelWired();
    const p = feat.properties || {};
    const sec = p.SECCION ?? '‚Äî';
    const df  = p[FIELD_KEYS.df] ?? '‚Äî';
    const dl  = p[FIELD_KEYS.dl] ?? '‚Äî';

    // LN 24DL_LN
    let ln = await getLN24DL(sec);
    if (ln==null) ln = '‚Äî';

    // Pintar
    const box = document.getElementById('sec-info');
    box.querySelector('.hdr').textContent = `Secci√≥n ${sec}`;
    document.getElementById('si-sec').textContent = sec;
    document.getElementById('si-df').textContent  = df;
    document.getElementById('si-dl').textContent  = dl;
    document.getElementById('si-ln').textContent  = ln;
    box.style.display = 'block';
    const lnSec = getLN2024(feat?.properties);
    
    await renderSocFicha(sec, lnSec);
    // al final de showSectionInfo(feat)‚Ä¶
     
  }



  // ENTER + CLIC + ULTIMO TOKEN

    function currentNeedle(q){
      if (!q) return '';
      const parts = String(q).split(/[,;\s]+/).filter(Boolean);
      return parts.length ? parts[parts.length-1] : '';
    }

// ===== Mini-selector de universo dentro del m√≥dulo =====
    let __mini = { selMun:null, selDf:null, selDl:null, all:null };

    function uniqueSorted(values){
    const arr = values.map(v => String(v ?? '').trim()).filter(Boolean);
    const set = Array.from(new Set(arr));
    return set.sort((a,b) => (isFinite(a)&&isFinite(b)) ? Number(a)-Number(b) : a.localeCompare(b,'es'));
    }
    function buildMiniOptions(raw){
    const feats = raw.features || [];
    const grab = k => uniqueSorted(feats.map(f => f.properties?.[k]));
    return { mun: grab(FIELD_KEYS.mun), df: grab(FIELD_KEYS.df), dl: grab(FIELD_KEYS.dl) };
    }
    function fillSelect(sel, arr){
    sel.innerHTML = '<option value="">‚Äî Ninguno ‚Äî</option>' + arr.map(v=>`<option value="${v}">${v}</option>`).join('');
    }
    function getMiniUniverse(){
    const { selMun, selDf, selDl, all } = __mini;
    if(all.checked) return { scope:'ALL', key:null, label:'Estado completo' };
    if(selMun.value) return { scope:'MUN', key: selMun.value, label:`Municipio ${selMun.options[selMun.selectedIndex].text}` };
    if(selDf.value)  return { scope:'DF',  key: selDf.value,  label:`Distrito Federal ${selDf.value}` };
    if(selDl.value)  return { scope:'DL',  key: selDl.value,  label:`Distrito Local ${selDl.value}` };
    return null;
    }
    function miniExclusivity(which){
    const { selMun, selDf, selDl, all } = __mini;
    if(which==='ALL'){ selMun.value=''; selDf.value=''; selDl.value=''; }
    if(which==='MUN'){ selDf.value=''; selDl.value=''; all.checked=false; }
    if(which==='DF'){  selMun.value=''; selDl.value=''; all.checked=false; }
    if(which==='DL'){  selMun.value=''; selDf.value=''; all.checked=false; }
    applyMiniUniverse();
    }
    function applyMiniUniverse(){
    const u2 = getMiniUniverse();
    if(!u2) return;
    // 1) Persistir
    localStorage.setItem('AT_UNIVERSE', JSON.stringify({ ...u2, ts:Date.now() }));
    // 2) Redibujar con el nuevo universo usando el raw ya cargado
    const atMap = ensureLeafletMap();
    const filtered2 = filterGeojson(window.AT_DATA, u2);
    if (window.AT_CTX?.layer) { atMap.removeLayer(AT_CTX.layer); }
    const layer2 = L.geoJSON(filtered2, { style:{ color:'#7d0025', weight:1.2, fillOpacity:0.15 } }).addTo(atMap);
    try { atMap.fitBounds(layer2.getBounds(), { padding:[20,20] }); } catch(e){}
    window.AT_CTX = { ...(window.AT_CTX||{}), universe: u2, layer: layer2 };
    // 3) Header
    const hdr = document.querySelector('#panel-header span');
    if(hdr){ hdr.textContent = `An√°lisis Territorial ¬∑ ${u2.label}`; }
      refreshSectionSearch(u2);
    }
    function initMiniSelector(raw, u){
    // Guardar el geojson bruto para futuros re-filtros
    window.AT_DATA = raw;

    __mini.selMun = document.getElementById('mini-sel-mun');
    labelMunicipiosFromCatalog('#mini-sel-mun');

    __mini.selDf  = document.getElementById('mini-sel-df');
    __mini.selDl  = document.getElementById('mini-sel-dl');
    __mini.all    = document.getElementById('mini-all-state');

    const opt = buildMiniOptions(raw);
    fillSelect(__mini.selMun, opt.mun);
    fillSelect(__mini.selDf,  opt.df);
    fillSelect(__mini.selDl,  opt.dl);

    // Reflejar el universo actual
    if(u.scope==='ALL'){ __mini.all.checked = true; }
    if(u.scope==='MUN'){ __mini.selMun.value = String(u.key); }
    if(u.scope==='DF'){  __mini.selDf.value  = String(u.key); }
    if(u.scope==='DL'){  __mini.selDl.value  = String(u.key); }


    
        async function labelMunicipiosFromCatalog(selectId){
        const sel = document.querySelector(selectId);
        if (!sel) return;

        // 1) Ruta del cat√°logo desde el Portal (AT_PATHS) o fallback
        let catUrl = 'data/catalogo_territorial.json';
        try {
            const paths = JSON.parse(localStorage.getItem('AT_PATHS') || '{}');
            if (paths?.catalog) catUrl = paths.catalog;
        } catch {}

        // 2) Cargar cat√°logo
        let cat = null;
        try {
            const r = await fetch(catUrl);
            if (!r.ok) throw new Error('HTTP '+r.status);
            cat = await r.json();
        } catch (e) {
            console.warn('[AT] No se pudo cargar el cat√°logo:', e);
            return; // salimos sin tocar etiquetas
        }

        const mapa = cat?.municipios || {};
        // helper: si el cat√°logo trae ceros a la izquierda en las llaves
        const getName = (code) => {
            const s = String(code);
            return mapa[s] || mapa[s.padStart(2,'0')] || mapa[s.padStart(3,'0')] || s;
        };

        // 3) Reetiquetar opciones (sin cambiar value)
        for (const opt of sel.options) {
            if (!opt.value) continue; // deja "‚Äî Ninguno ‚Äî"
            const name = getName(opt.value);
            opt.text = `${opt.value} ‚Äî ${name}`;
        }
        }

   

    // Eventos (auto-ejecuta)
    __mini.selMun.addEventListener('change', ()=> miniExclusivity('MUN'));
    __mini.selDf .addEventListener('change', ()=> miniExclusivity('DF'));
    __mini.selDl .addEventListener('change', ()=> miniExclusivity('DL'));
    __mini.all   .addEventListener('change', ()=> miniExclusivity('ALL'));
    }


    // Nombre fijo del campo (texto) del municipio
    const MUN_NAME_KEY = 'MUNICIPIO';

    // Detecta autom√°ticamente el campo de C√ìDIGO de municipio (si no, usa el nombre)
    function detectMunCodeKey(raw){
    const feats = raw.features || [];
    const candidates = ['MUN','CVE_MUN','CLV_MUN','ID_MUN','MUNICIPIO_ID','MUNICIPIO_CVE','CVE_MUNICIPIO','CVE_MPIO'];
    for (const k of candidates) {
        const ok = feats.some(f => {
        const v = f.properties?.[k];
        return v != null && String(v).trim() !== '' && String(v).toUpperCase() !== 'NULL';
        });
        if (ok) return k;
    }
    return null; // fallback ser√° MUN_NAME_KEY
    }



      // ‚Äî‚Äî Utils de texto ‚Äî‚Äî
      function _norm(s){
        if (s==null) return '';
        return String(s).normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase().trim();
      }
      function _isDigits(s){ return /^[0-9]+$/.test(String(s||'')); }

      // ‚Äî‚Äî Nombre de municipio desde cat√°logo (si existe) ‚Äî‚Äî
      function getMunNameFromCatalog(code){
        const cat = window.AT_CATALOG;
        if (!cat?.municipios) return String(code ?? '');
        const s = String(code);
        // maneja posibles ceros a la izquierda
        return cat.municipios[s] || cat.municipios[s.padStart(2,'0')] || cat.municipios[s.padStart(3,'0')] || s;
      }

      // ‚Äî‚Äî √çndice de secciones ‚Äî‚Äî
      let __SEC_INDEX = { items: [], global: false };

      function buildSectionIndex(raw, universe, useGlobal){
        const feats = (raw?.features || []);
        const munKey = (window.AT_KEYS?.munCode) || FIELD_KEYS.mun;
        const items = [];

        // dataset base: global = todas, local = filtradas por universo
        const base = useGlobal ? feats : (filterGeojson(raw, universe).features || []);

        for(const f of base){
          const p = f.properties || {};
          const sec = p.SECCION ?? p.Seccion ?? p.seccion ?? null;
          if (sec == null) continue;

          const munCode = p[munKey];
          const munName = getMunNameFromCatalog(munCode);
          const df = p[FIELD_KEYS.df];
          const dl = p[FIELD_KEYS.dl];

          // texto para b√∫squeda
          const text = `${sec} ${munCode ?? ''} ${munName ?? ''} ${df ?? ''} ${dl ?? ''}`;
          // bounds (si multiparte, Leaflet lo resuelve)
          let bounds = null;
          try { bounds = L.geoJSON(f).getBounds(); } catch(_){}

          items.push({
            sec: String(sec).trim(),
            munCode: munCode,
            munName: munName,
            df, dl, feature: f, textNorm: _norm(text), bounds
          });
        }

        __SEC_INDEX = { items, global: !!useGlobal };
      }

      function searchSections(query, limit=15){
        const q = _norm(query);
        if (!q) return [];
        const ds = __SEC_INDEX.items;

        // Heur√≠stica sencilla:
        // - si es num√©rico puro: prioridad a SECCION que empiece con q
        // - si no: contiene tokens
        if (_isDigits(q)){
          const starts = ds.filter(it => _norm(it.sec).startsWith(q));
          if (starts.length >= limit) return starts.slice(0, limit);
          const contains = ds.filter(it => _norm(it.sec).includes(q));
          return [...starts, ...contains].slice(0, limit);
        } else {
          const tokens = q.split(/\s+/).filter(Boolean);
          return ds.filter(it => tokens.every(t => it.textNorm.includes(t))).slice(0, limit);
        }
      }

      // ‚Äî‚Äî UI de sugerencias ‚Äî‚Äî
      let __SEC_HIGHLIGHT = null;

      function renderSecSuggestions(list){
        const ul = document.getElementById('sec-suggest');
        if (!ul) return;
        if (!list.length){ ul.style.display='none'; ul.innerHTML=''; return; }

        ul.innerHTML = list.map(it => {
          const label = `${it.sec} ‚Äî ${it.munName || it.munCode || ''}`.replace(/\s+-\s+$/, '');
          const meta  = [];
          if (it.dl!=null) meta.push(`DL ${it.dl}`);
          if (it.df!=null) meta.push(`DF ${it.df}`);
          const sub = meta.length ? `<small style="color:#64748b">${meta.join(' ¬∑ ')}</small>` : '';
          return `<li data-sec="${it.sec}" style="padding:6px 8px; border-bottom:1px solid #e5e7eb; cursor:pointer">
                    <div>${label}</div>${sub}
                  </li>`;
        }).join('');
        ul.style.display = 'block';


      }

    function gotoSection(item){
      const atMap = (window.AT_CTX?.map) || ensureLeafletMap();

      // 1) Resolver el feature de la secci√≥n
      const sec = String(item.sec ?? item.SECCION ?? '');
      let feat = item.feature;

      if (!feat) {
        const feats =
          (window.AT_CTX?.layer?.toGeoJSON?.().features) ||
          (window.AT_DATA?.features) || [];
        feat = feats.find(f => String(f.properties?.SECCION) === sec);
      }

      if (!feat) {
        console.warn('[AT] No encontr√© el feature para la secci√≥n', sec, item);
        return;
      }

      // 2) Pintar selecci√≥n + adyacentes + labels (esto limpia overlays previos)
      paintSelectionAndAdj(feat);

      // 3) Mostrar panel con DF, DL y LN (24DL_LN)
      showSectionInfo(feat);

      // 4) Feedback visual (parpadeo leve sobre el highlight actual)
      const hl = window.__SEC_HL;
      if (hl && typeof hl.setStyle === 'function') {
        try {
          hl.setStyle({ weight: 4 });
          setTimeout(() => { try { hl.setStyle({ weight: 3 }); } catch(_){} }, 220);
        } catch(_){}
      }

      // 5) Oculta la lista de sugerencias (si est√° visible)
      const ul = document.getElementById('sec-suggest');
      if (ul) ul.style.display = 'none';
    }


      // Delegaci√≥n de clic en las sugerencias (una sola vez)
    (function wireSectionSearchEventsOnce(){
      const ul = document.getElementById('sec-suggest');
      const input = document.getElementById('sec-q');
      if (!ul || !input) return;

       // Si est√° dentro de un form, evita submit al Enter
      const form = input.closest('form');
      form?.addEventListener('submit', e => e.preventDefault());

      // Clic en cualquier <li data-sec="...">
      if (!ul.__wiredClick){
        ul.addEventListener('click', (ev)=>{
          const li = ev.target.closest('li[data-sec]');
          if (!li) return;
          const sec = li.getAttribute('data-sec');
          const item = (__SEC_INDEX?.items||[]).find(x => String(x.sec) === String(sec));
          if (item) gotoSection(item);
          ul.style.display = 'none';
        });
        ul.__wiredClick = true;
      }

      // Enter en el input = ir al primer resultado
      if (!input.__wiredKey){
        input.addEventListener('keydown', (ev)=>{
          if (ev.key === 'Enter'){
            ev.preventDefault(); // <- evita submit/autocomplete
            const results = searchSections(input.value, 1);
        const needle = currentNeedle(input.value);
        const [first] = searchSections(needle, 1);
        if (first) gotoSection(first);
        ul.style.display = 'none';
       }
          if (ev.key === 'Escape'){
            ul.style.display = 'none';
          }
        });
        input.__wiredKey = true;
      }

      // Input: recalcula sugerencias usando el "√∫ltimo token"
      if (!input.__wiredInput){
        input.addEventListener('input', ()=>{
          const needle = currentNeedle(input.value);
          renderSecSuggestions(searchSections(needle, 15));
        });
        input.__wiredInput = true;
      }
    })();


      // ‚Äî‚Äî Inicializar Buscador en el m√≥dulo ‚Äî‚Äî
      function initSectionSearch(raw, universe){
        const input   = document.getElementById('sec-q');
        const list    = document.getElementById('sec-suggest');
        const globalC = document.getElementById('sec-global');
        if (!input || !list) return;

        // construir √≠ndice (por universo actual)
        buildSectionIndex(raw, universe, !!globalC?.checked);



        // Cambiar √°mbito (global / universo actual)
        globalC?.addEventListener('change', () => {
          buildSectionIndex(raw, universe, !!globalC.checked);
          // refresca sugerencias con la query actual
          if (input.value){
            renderSecSuggestions(searchSections(input.value, 15));
          }
        });
      }

      // ‚Äî‚Äî Cuando cambies de universo con tu mini-selector, reindexa ‚Äî‚Äî
      function refreshSectionSearch(universe){
        const input   = document.getElementById('sec-q');
        const globalC = document.getElementById('sec-global');
        if (!window.AT_DATA || !input) return;
        buildSectionIndex(window.AT_DATA, universe, !!globalC?.checked);
        if (input.value){
          renderSecSuggestions(searchSections(input.value, 15));
        }
      }


      function getRawForIndex(){
        // Usa el dataset completo si ya lo cacheaste
        if (window.AT_DATA) return window.AT_DATA;
        // Si no, al menos usa lo ya pintado en el mapa
        const lyr = window.AT_CTX?.layer;
        return (lyr && typeof lyr.toGeoJSON === 'function') ? lyr.toGeoJSON() : null;
  }


  // ===== 3) Boot =====
  document.addEventListener('DOMContentLoaded', async () => {
    // a) Leer universo y rutas puestos en el PORTAL
    const u     = JSON.parse(localStorage.getItem('AT_UNIVERSE') || 'null');
    const paths = JSON.parse(localStorage.getItem('AT_PATHS') || '{"geo":""}');
    if (!u) {
      const hdr = document.querySelector('#panel-header span');
      hdr && (hdr.textContent += ' ¬∑ selecciona el universo en el Portal');
      setTimeout(()=>{ location.href = 'portal.html'; }, 600);
      return;
    }

    // b) Etiqueta del universo
    const hdr = document.querySelector('#panel-header span');
    hdr && (hdr.textContent += ` ¬∑ ${u.label}`);

    // c) Mapa √∫nico
    const atMap = ensureLeafletMap();
    assertIsLeafletMap(atMap);

    // d) Cargar y filtrar GeoJSON
    const url = paths.geo || 'data/geo/secciones.geojson'; // <-- ajusta si tu ruta difiere

    // Cargar cat√°logo territorial (para nombres visibles)
    const catUrl = (paths.catalog && paths.catalog.trim()) || '/data/catalogo_territorial.json';
    let catalog = window.AT_CATALOG || null;
    if (!catalog) {
    try {
        const rc = await fetch(catUrl);
        if (!rc.ok) throw new Error(`HTTP ${rc.status} al cargar cat√°logo ${catUrl}`);
        catalog = await rc.json();
        window.AT_CATALOG = catalog;
    } catch (err) {
        console.warn('[AT] No se pudo cargar el cat√°logo de nombres:', err);
        window.AT_CATALOG = catalog = null; // seguimos sin nombres amigables
    }
    }


 let raw = window.AT_DATA || null; // usa cach√© si ya existe
if (!raw) {
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status} al cargar ${url}`);
    raw = await res.json();       // ‚úÖ solo una vez
    window.AT_DATA = raw;         // ‚úÖ guarda en cach√© aqu√≠
  } catch (err) {
    console.error('[AT] Error cargando GeoJSON:', err);
    alert('No se pudo cargar el GeoJSON');
    return;
  }
}
// a partir de aqu√≠, usa 'raw'

    const filtered = filterGeojson(raw, u);
    console.log('[AT] Universo:', u, 'Total:', raw.features?.length||0, 'Filtradas:', filtered.features?.length||0);

    if(!filtered.features || filtered.features.length===0){
      console.warn('[AT] No hay geometr√≠as para el universo seleccionado:', u);
      alert('No hay datos para el universo seleccionado');
    }

    // Nombre fijo del campo (texto) del municipio
        const MUN_NAME_KEY = 'MUNICIPIO';

    // Detecta campo de C√ìDIGO (si existe); si no, usa el de nombre
        function detectMunCodeKey(raw){
        const feats = raw.features || [];
        const candidates = ['MUN','CVE_MUN','CLV_MUN','ID_MUN','MUNICIPIO_ID','MUNICIPIO_CVE','CVE_MUNICIPIO','CVE_MPIO'];
        for (const k of candidates) {
            if (feats.some(f => (f.properties?.[k] ?? '') !== '')) return k;
        }
        return null;
        }

        const munCodeKey = detectMunCodeKey(raw) || MUN_NAME_KEY; // fallback: nombre
        FIELD_KEYS.mun = munCodeKey;
        window.AT_KEYS = { munCode: munCodeKey, munName: MUN_NAME_KEY };


    // e) Dibujar capa
        const layer = L.geoJSON(filtered, {
      style: { color:'#000000', weight:1.2, fillOpacity:0.15 },
      onEachFeature: (feat, lyr) => {
        const p = feat.properties || {};
        const muni = p[FIELD_KEYS.mun] ?? '‚Äî';
        const dl   = p[FIELD_KEYS.dl]  ?? '‚Äî';
        const df   = p[FIELD_KEYS.df]  ?? '‚Äî';
        lyr.bindPopup(`<b>Secci√≥n</b>: ${p.SECCION ?? '‚Äî'}<br><b>Mun</b>: ${muni}<br><b>DL</b>: ${dl}<br><b>DF</b>: ${df}`);
        lyr.on('mouseover', () => lyr.setStyle({weight:2}));
        lyr.on('mouseout',  () => lyr.setStyle({weight:1.2}));
      }
    }).addTo(atMap);

    try { atMap.fitBounds(layer.getBounds(), { padding:[20,20] }); } catch(e){}
    window.AT_CTX = { universe: u, paths, map: atMap, layer };

    function getMunNameFromCatalog(code){
  const cat = window.AT_CATALOG;
  if (!cat?.municipios) return String(code ?? '');
  return cat.municipios[String(code)] || String(code ?? '');
}
function getDfListFromCatalog(feats){
  return (window.AT_CATALOG?.distritos_federales && window.AT_CATALOG.distritos_federales.length)
    ? window.AT_CATALOG.distritos_federales
    : uniqSorted(feats.map(f => f.properties?.[FIELD_KEYS.df]));
}
function getDlListFromCatalog(feats){
  return (window.AT_CATALOG?.distritos_locales && window.AT_CATALOG.distritos_locales.length)
    ? window.AT_CATALOG.distritos_locales
    : uniqSorted(feats.map(f => f.properties?.[FIELD_KEYS.dl]));
}
    initMiniSelector(raw, u);
    initSectionSearch(window.AT_DATA || raw, u);

  });

  (function wireATHotkeys(){
      if (window.__AT_HOTKEYS) return;
      window.__AT_HOTKEYS = true;

      window.addEventListener('keydown', (e)=>{
        // Esc: cerrar panel
        if (e.key === 'Escape'){
          if (document.getElementById('sec-info')?.style.display !== 'none'){
            e.preventDefault();
            closeSecInfoPanel();
          }
        }
        // Ctrl+K (o Cmd+K en Mac): enfocar buscador de secciones
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k'){
          e.preventDefault();
          document.getElementById('sec-q')?.focus();
        }
      });
    })();

    // ===== AQUI EMPIEZA: JS Barra SOCIAL (SOC_TB) =====
    (function SOC_TB_boot(){
      // 0) Estado local
      const TB = {
        box: null, lastFeat: null, labelsOn: true, adjOn: true
      };

      // 1) Helper: guarda √∫ltima secci√≥n seleccionada (hook en gotoSection)
      const __origGoto = window.gotoSection;
      window.gotoSection = function patchedGotoSection(item){
        __origGoto.call(this, item);
        try {
          // Intenta resolver el feature seleccionado y guardarlo
          const sec = String(item.sec ?? item.SECCION ?? '');
          const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
          const feat = feats.find(f => String(f.properties?.SECCION) === sec);
          if (feat) TB.lastFeat = feat;

          // Actualiza hash compartible, p.ej. #sec=1234
          if (sec) {
            const url = new URL(location.href);
            url.hash = `sec=${sec}`;
            history.replaceState(null, '', url);
          }
        } catch(_) {}
      };

      // 2) Toggling de adyacentes / etiquetas usando tus overlays
      function toggleAdj(){
        TB.adjOn = !TB.adjOn;
        const map = (window.AT_CTX?.map) || ensureLeafletMap();
        // Si est√°n prendidos y existen, ap√°galos
        if (!TB.adjOn) {
          if (window.__SEC_ADJ){ try{ map.removeLayer(__SEC_ADJ); }catch(_){} window.__SEC_ADJ=null; }
        } else if (TB.lastFeat){
          // volver a calcular adyacentes para la √∫ltima secci√≥n
          const adj = getAdjacents(TB.lastFeat);
          if (adj.length){
            window.__SEC_ADJ = L.geoJSON({type:'FeatureCollection', features:adj},
              { style:{ color:'#90a4ae', weight:1.2, dashArray:'4,4', fillOpacity:0.05 } })
              .addTo(map);
          }
        }
      }

      function toggleLabels(){
        TB.labelsOn = !TB.labelsOn;
        const map = (window.AT_CTX?.map) || ensureLeafletMap();
        if (!TB.labelsOn){
          if (window.__SEC_LABELS){ try{ map.removeLayer(__SEC_LABELS); }catch(_){} window.__SEC_LABELS=null; }
        } else if (TB.lastFeat){
          // repinta etiqueta principal y de adyacentes de la √∫ltima selecci√≥n
          const sec = TB.lastFeat.properties?.SECCION ?? '‚Äî';
          addLabelForFeature(TB.lastFeat, 'sec-label', `Secci√≥n ${sec}`);
          const adj = getAdjacents(TB.lastFeat);
          for (const f of adj){
            const s2 = f.properties?.SECCION ?? '‚Äî';
            addLabelForFeature(f, 'sec-label-adj', s2);
          }
        }
      }

      // 3) Focus a la √∫ltima secci√≥n (fitBounds)
      function focusLast(){
        const map = (window.AT_CTX?.map) || ensureLeafletMap();
        if (!TB.lastFeat){ return; }
        try {
          const hl = window.__SEC_HL || L.geoJSON(TB.lastFeat);
          const b  = hl.getBounds ? hl.getBounds() : L.geoJSON(TB.lastFeat).getBounds();
          map.fitBounds(b, { padding:[28,28] });
        } catch(_){}
      }

      // 4) Limpiar
      function clearAll(){
        closeSecInfoPanel();
        clearSectionOverlays(); // ya la traes
        TB.lastFeat = null;
        // Limpia hash
        if (location.hash.includes('sec=')){
          const url = new URL(location.href); url.hash = ''; history.replaceState(null, '', url);
        }
      }

      // 5) Exportar PNG del mapa (usa tu html2canvas cargado)
      async function exportPNG(){
        const node = document.getElementById('map');
        if (!node) return;
        const canvas = await html2canvas(node, { useCORS:true, backgroundColor: null });
        const link = document.createElement('a');
        link.download = `SOCIAL_mapa_${Date.now()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      }

      // 6) Copiar liga con #sec=...
      async function shareLink(){
        try {
          await navigator.clipboard.writeText(location.href);
          alert('Liga copiada al portapapeles.');
        } catch(_){
          prompt('Copia la liga:', location.href);
        }
      }

      // 7) Wire UI + hotkeys
      function wire(){
        TB.box = document.getElementById('SOC_TB');
        if (!TB.box || TB.box.__wired) return;

        TB.box.querySelector('#SOC_TB_toggle').addEventListener('click', ()=>{
          // Dentro del click de #SOC_TB_toggle:
          const isTop = TB.box.classList.contains('soc-tb--top');
          TB.box.classList.toggle('soc-tb-open');
          TB.box.querySelector('#SOC_TB_toggle').textContent =
            TB.box.classList.contains('soc-tb-open')
              ? (isTop ? '‚ñ¥' : '¬´')   // abierto: arriba muestra flecha hacia arriba
              : (isTop ? '‚ñæ' : '¬ª');  // cerrado: arriba muestra flecha hacia abajo

          TB.box.querySelector('#SOC_TB_toggle').textContent = TB.box.classList.contains('soc-tb-open') ? '¬´' : '¬ª';
        });
        TB.box.querySelector('#SOC_TB_focus') .addEventListener('click', focusLast);
        TB.box.querySelector('#SOC_TB_adj')   .addEventListener('click', toggleAdj);
        TB.box.querySelector('#SOC_TB_labels').addEventListener('click', toggleLabels);
        TB.box.querySelector('#SOC_TB_clear') .addEventListener('click', clearAll);
        TB.box.querySelector('#SOC_TB_export').addEventListener('click', exportPNG);
        TB.box.querySelector('#SOC_TB_share') .addEventListener('click', shareLink);

        // Hotkeys r√°pidas mientras est√° este m√≥dulo abierto
        window.addEventListener('keydown', (e)=>{
          if (e.target && ['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
          if (e.key.toLowerCase() === 'f') focusLast();
          if (e.key.toLowerCase() === 'a') toggleAdj();
          if (e.key.toLowerCase() === 'l') toggleLabels();
          if (e.key.toLowerCase() === 'c') clearAll();
          if (e.key.toLowerCase() === 'e') exportPNG();
          if (e.key.toLowerCase() === 's') shareLink();
        });

        TB.box.__wired = true;
      }

      // 8) Abrir por hash (#sec=1234) cuando llegas con liga
      function openFromHashOnce(){
        const m = (location.hash || '').match(/sec=(\d+)/i);
        if (!m) return;
        const sec = m[1];
        // Espera a que exista el √≠ndice del buscador
        const tryOpen = ()=>{
          const item = (__SEC_INDEX?.items||[]).find(x => String(x.sec) === String(sec));
          if (item){ window.gotoSection(item); return true; }
          return false;
        };
        // Reintento breve si a√∫n no est√° construido
        let n=0, h=setInterval(()=>{ if (tryOpen() || ++n>30) clearInterval(h); }, 150);
      }

      // 9) Ejecutar al cargar DOM
      document.addEventListener('DOMContentLoaded', ()=>{
        wire();
        openFromHashOnce();
      });
    })();
  // ===== AQUI TERMINA: JS Barra SOCIAL (SOC_TB) =====

    // ===== FICHA SOCIOECON√ìMICA (SECCI√ìN) [SOC_FICHA_v1_2020] =====
    (function(){
      const SOC_FICHA = {
        ROUTES: { json: 'data/Datos_Socioeconomicos.json' }, // <-- ajusta si tu ruta difiere
        bySec: new Map(),
        loaded: false,
        fmt0: new Intl.NumberFormat('es-MX'),
        fmt1: new Intl.NumberFormat('es-MX', { maximumFractionDigits: 1 }),
        fmt2: new Intl.NumberFormat('es-MX', { maximumFractionDigits: 2 }),
      };

      const safeDiv = (a,b)=> (b && b!==0) ? (a/b) : 0;

    async function loadSocioIfNeeded(){
      if (SOC_FICHA.loaded) return;

      let arr = [];
      try {
        const res = await fetch(SOC_FICHA.ROUTES.json);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const raw = await res.json();

        // Normalizaciones de forma
        if (Array.isArray(raw)) {
          arr = raw;
        } else if (raw && Array.isArray(raw.data)) {
          arr = raw.data;
        } else if (raw && Array.isArray(raw.rows)) {
          arr = raw.rows;
        } else if (raw && raw.features && Array.isArray(raw.features)) {
          // Por si vino como GeoJSON u objeto con features
          arr = raw.features.map(f => ({ SECCION: f.properties?.SECCION, ...f.properties }));
        } else if (raw && typeof raw === 'object') {
          // Objeto indexado por secci√≥n -> a arreglo
          arr = Object.values(raw);
        } else {
          arr = [];
        }
      } catch (e) {
        console.error('SOC_FICHA: no se pudo leer el JSON', e);
        arr = [];
      }

      SOC_FICHA.bySec.clear();

      // Itera ya normalizado
      for (const r0 of arr) {
        // Asegurar que venga plano (no anidado en .properties)
        const r = r0 && r0.properties
          ? { SECCION: r0.SECCION ?? r0.properties.SECCION, ...r0, ...(r0.properties||{}) }
          : r0 || {};

        const seccion = String(r.SECCION ?? r.Seccion ?? r.seccion ?? '');
        if (!seccion) continue;

        const POB_15MAS = (r.POB_15_17||0) + (r.POB_18MAS||0);
        const PEA       = (r.OCUPADOS_12MAS||0) + (r.DESOCUPADOS_12MAS||0);

        SOC_FICHA.bySec.set(seccion, {
          ...r,
          POB_15MAS,
          TASA_ANALF_15MAS: (PEA===0 && POB_15MAS===0) ? 0 : ((r.ANALFABETAS_15MAS||0) / (POB_15MAS || 1)) * 100,
          TASA_DESEMP:      ((r.DESOCUPADOS_12MAS||0) / ((PEA)||1)) * 100,
          SERV_ELECTRICIDAD_PMH: ((r.VIV_CON_ELECTRICIDAD||0) / (r.POB_TOTAL||1))*1000,
          SERV_AGUA_PMH:         ((r.VIV_CON_AGUA||0)         / (r.POB_TOTAL||1))*1000,
          SERV_DRENAJE_PMH:      ((r.VIV_CON_DRENAJE||0)      / (r.POB_TOTAL||1))*1000,
          SERV_INTERNET_PMH:     ((r.VIV_CON_INTERNET||0)     / (r.POB_TOTAL||1))*1000,
          SERV_CEL_PMH:          ((r.VIV_CON_CEL||0)          / (r.POB_TOTAL||1))*1000,
          SERV_PC_PMH:           ((r.VIV_CON_PC||0)           / (r.POB_TOTAL||1))*1000,
        });
      }

      SOC_FICHA.loaded = true;
    }


      function renderSocioCard(secId){
        const sec = String(secId ?? '');
        const el = id => document.getElementById(id);
        el('SOC_FICHA_badge').textContent = `Secci√≥n ${sec || '‚Äî'}`;

        const r = SOC_FICHA.bySec.get(sec);
        if(!r){
          // limpia
          el('SOCF_kpi_analf').textContent = '‚Äî';
          el('SOCF_kpi_desemp').textContent = '‚Äî';
          el('SOCF_kpi_esco').textContent = '‚Äî';
          el('SOCF_pob_total').textContent = '‚Äî';
          el('SOCF_pob_15mas').textContent = '‚Äî';
          el('SOCF_pob_18mas').textContent = '‚Äî';
          el('SOCF_elec').textContent = el('SOCF_agua').textContent =
          el('SOCF_dren').textContent = el('SOCF_net').textContent =
          el('SOCF_cel').textContent  = el('SOCF_pc').textContent  = '‚Äî';
          return;
        }

        // KPIs
        el('SOCF_kpi_analf').textContent = SOC_FICHA.fmt1.format(r.TASA_ANALF_15MAS);
        el('SOCF_kpi_desemp').textContent = SOC_FICHA.fmt1.format(r.TASA_DESEMP);
        el('SOCF_kpi_esco').textContent  = SOC_FICHA.fmt1.format(r.ESCOLARIDAD_PROM || 0);

        // Poblaci√≥n
        el('SOCF_pob_total').textContent = SOC_FICHA.fmt0.format(r.POB_TOTAL || 0);
        el('SOCF_pob_15mas').textContent = SOC_FICHA.fmt0.format(r.POB_15MAS || 0);
        el('SOCF_pob_18mas').textContent = SOC_FICHA.fmt0.format(r.POB_18MAS || 0);

        // Servicios (por mil hab.)
        el('SOCF_elec').textContent = SOC_FICHA.fmt1.format(r.SERV_ELECTRICIDAD_PMH);
        el('SOCF_agua').textContent = SOC_FICHA.fmt1.format(r.SERV_AGUA_PMH);
        el('SOCF_dren').textContent = SOC_FICHA.fmt1.format(r.SERV_DRENAJE_PMH);
        el('SOCF_net').textContent  = SOC_FICHA.fmt1.format(r.SERV_INTERNET_PMH);
        el('SOCF_cel').textContent  = SOC_FICHA.fmt1.format(r.SERV_CEL_PMH);
        el('SOCF_pc').textContent   = SOC_FICHA.fmt1.format(r.SERV_PC_PMH);
      }

      // Hook suave: conserva tu gotoSection y solo a√±ade la actualizaci√≥n de la ficha
      const __origGoto = window.gotoSection;
      window.gotoSection = async function patchedGotoSection(item){
        __origGoto.call(this, item);
        try{
          await loadSocioIfNeeded();
          const sec = item?.sec ?? item?.SECCION ?? item?.Seccion ?? '';
          renderSocioCard(sec);
        }catch(e){ /* no interrumpir tu flujo */ }
      };

      // Si llegas con hash #sec=####, intenta pintar la ficha tras cargar socio
      document.addEventListener('DOMContentLoaded', async ()=>{
        const m = (location.hash||'').match(/sec=(\d+)/i);
        if (m){
          await loadSocioIfNeeded();
          renderSocioCard(m[1]);
        }
      });
    })();


  </script>
  <div id="sec-info">
    <div class="hdr">
      <span class="ttl">Secci√≥n</span>
      <button id="sec-close" class="btn-close" aria-label="Cerrar">√ó</button>
    </div>
    <div class="body">
      <div class="row"><span class="k">Secci√≥n</span>        <span class="v" id="si-sec">‚Äî</span></div>
      <div class="row"><span class="k">Distrito Federal</span><span class="v" id="si-df">‚Äî</span></div>
      <div class="row"><span class="k">Distrito Local</span>  <span class="v" id="si-dl">‚Äî</span></div>
      <div class="row"><span class="k">LN (2024)</span>    <span class="v" id="si-ln">‚Äî</span></div>

      <hr class="socf-split">

    <div id="SOCF_card" class="socf-card" style="margin-top:6px">
      <div style="font-weight:700; margin:4px 0 8px 0;">Ficha socioecon√≥mica</div>

      <div class="row"><span class="k">Poblaci√≥n total (2020)</span>     <span class="v" id="SOCF_pob">‚Äî</span></div>
      <div class="row"><span class="k">Poblaci√≥n 18+</span>     <span class="v" id="SOCF_pob_18mas">‚Äî</span></div>
      <div class="row">
        <span class="k">Poblaci√≥n 18+ (2027, proj)</span>
        <span class="v" id="SOCF_pob18_2027">‚Äî</span>
      </div>

      <div class="row"><span class="k">% Analfabetismo (15+)</span><span class="v" id="SOCF_analf">‚Äî</span></div>
      <div class="row"><span class="k">% Desempleo (12+)</span>   <span class="v" id="SOCF_desemp">‚Äî</span></div>

      <div style="margin-top:6px; font-size:12px; color:#64748b">Servicios por 1,000 hab.</div>
      <div class="row"><span class="k">Electricidad</span> <span class="v" id="SOCF_ele">‚Äî</span></div>
      <div class="row"><span class="k">Agua</span>         <span class="v" id="SOCF_agua">‚Äî</span></div>
      <div class="row"><span class="k">Drenaje</span>      <span class="v" id="SOCF_dre">‚Äî</span></div>
      <div class="row"><span class="k">Internet</span>     <span class="v" id="SOCF_net">‚Äî</span></div>
      <div class="row"><span class="k">Celular</span>      <span class="v" id="SOCF_cel">‚Äî</span></div>
      <div class="row"><span class="k">Computadora</span>  <span class="v" id="SOCF_pc">‚Äî</span></div>
    </div>

    </div>  
  </div>

  <!-- === FICHA SOCIOECON√ìMICA (SECCI√ìN) [SOC_FICHA_v1_2020] === -->
  <section id="SOC_FICHA_card" class="socf-card" aria-live="polite">
    <header class="socf-header">
      <h3>Ficha socioecon√≥mica</h3>
      <small id="SOC_FICHA_badge">Secci√≥n ‚Äî</small>
    </header>

    <div class="socf-kpis">
      <div class="socf-kpi">
        <div class="kpi-label">Analf. 15+ (%)</div>
        <div class="kpi-val" id="SOCF_kpi_analf">‚Äî</div>
      </div>
      <div class="socf-kpi">
        <div class="kpi-label">Desempleo (%)</div>
        <div class="kpi-val" id="SOCF_kpi_desemp">‚Äî</div>
      </div>
      <div class="socf-kpi">
        <div class="kpi-label">Escolaridad (a√±os)</div>
        <div class="kpi-val" id="SOCF_kpi_esco">‚Äî</div>
      </div>
    </div>

    <div class="socf-grid">
      <div class="socf-row"><span>Poblaci√≥n total</span><b id="SOCF_pob_total">‚Äî</b></div>
      <div class="socf-row"><span>Poblaci√≥n 15+</span><b id="SOCF_pob_15mas">‚Äî</b></div>
      <div class="socf-row"><span>Poblaci√≥n 18+</span><b id="SOCF_pob_18mas">‚Äî</b></div>
    </div>

    <h4 class="socf-subttl">Servicios (por mil hab.)</h4>
    <div class="socf-grid">
      <div class="socf-row"><span>Electricidad</span><b id="SOCF_elec">‚Äî</b></div>
      <div class="socf-row"><span>Agua</span><b id="SOCF_agua">‚Äî</b></div>
      <div class="socf-row"><span>Drenaje</span><b id="SOCF_dren">‚Äî</b></div>
      <div class="socf-row"><span>Internet</span><b id="SOCF_net">‚Äî</b></div>
      <div class="socf-row"><span>Celular</span><b id="SOCF_cel">‚Äî</b></div>
      <div class="socf-row"><span>Computadora</span><b id="SOCF_pc">‚Äî</b></div>
    </div>

    <footer class="socf-foot">
      <small>Fuente: datos 2020. Si en el futuro tienes <code>VIV_TOTAL</code>, cambiamos a % por vivienda.</small>
    </footer>
  </section>
<!-- === /FICHA SOCIOECON√ìMICA === -->


</body>
</html>
